---
grafana_agent_default_config:
  metrics:
    global:
      scrape_interval: 15s
      external_labels: "{{ grafana_agent_external_labels }}"
      remote_write:
        - url: "{{ grafana_agent_metrics_url }}"
          headers:
            X-Scope-OrgID: "{{ grafana_agent_tenant }}"
    wal_directory: "{{ grafana_agent_wal_directory }}"
  integrations:
    agent:
      enabled: true
      instance: "{{ inventory_hostname }}"
    node_exporter:
      enabled: true
      instance: "{{ inventory_hostname }}"
      include_exporter_metrics: true
      enable_collectors:
        - ethtool
        - ksmd
        - systemd
        - tcpstat
  logs:
    positions_directory: "{{ grafana_agent_positions_directory }}"
    configs:
      - name: journal
        scrape_configs:
          - job_name: journal
            journal:
              max_age: 12h
              labels:
                job: systemd-journal
                instance: "{{ inventory_hostname }}"
            relabel_configs:
              - source_labels: [__journal__systemd_unit]
                target_label: unit
              - source_labels: [__journal_priority_keyword]
                target_label: level
        clients:
          - url: "{{ grafana_agent_logs_url }}"
            tenant_id: "{{ grafana_agent_tenant }}"
            external_labels: "{{ grafana_agent_external_labels }}"

grafana_agent_combined_config: >-
  {{
    grafana_agent_default_config |
    combine(grafana_agent_config, recursive=True, list_merge="append")
  }}
