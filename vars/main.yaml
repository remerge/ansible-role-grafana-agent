---
grafana_agent_default_config:
  metrics:
    global:
      scrape_interval: 15s
      external_labels: "{{ grafana_agent_external_labels }}"
      remote_write:
        - url: "{{ grafana_agent_metrics_url }}"
          headers:
            X-Scope-OrgID: "{{ grafana_agent_tenant }}"
    wal_directory: "{{ grafana_agent_wal_directory }}"
  integrations:
    agent:
      enabled: true
      instance: "{{ inventory_hostname }}"
    node_exporter:
      enabled: true
      instance: "{{ inventory_hostname }}"
      include_exporter_metrics: true
      enable_collectors:
        - ethtool
        - ksmd
        - systemd
        - tcpstat
  logs:
    positions_directory: "{{ grafana_agent_positions_directory }}"
    configs:
      - name: journal
        scrape_configs:
          - job_name: journal
            journal:
              max_age: 12h
              labels:
                job: systemd-journal
                instance: "{{ inventory_hostname }}"
            relabel_configs:
              - source_labels: [__journal__systemd_unit]
                target_label: unit
              - source_labels: [__journal_priority_keyword]
                target_label: level
          - job_name: docker_sd
            docker_sd_configs:
              - host: unix:///var/run/docker.sock
            relabel_configs:
              - source_labels: ['__meta_docker_container_label_com_hashicorp_nomad_alloc_id']
                target_label: 'alloc_id'
              - source_labels: ['__meta_docker_container_label_com_hashicorp_nomad_job_id']
                target_label: 'job_id'
              - source_labels: ['__meta_docker_container_label_com_hashicorp_nomad_job_name']
                target_label: 'job_name'
              - source_labels: ['__meta_docker_container_label_com_hashicorp_nomad_namespace']
                target_label: 'namespace'
              - source_labels: ['__meta_docker_container_label_com_hashicorp_nomad_node_id']
                target_label: 'node_id'
              - source_labels: ['__meta_docker_container_label_com_hashicorp_nomad_node_name']
                target_label: 'node_name'
              - source_labels: ['__meta_docker_container_label_com_hashicorp_nomad_task_group_name']
                target_label: 'task_group_name'
              - source_labels: ['__meta_docker_container_label_com_hashicorp_nomad_task_name']
                target_label: 'task_name'
            pipeline_stages:
              - docker: {}
              - static_labels:
                  source: "nomad"
        clients:
          - url: "{{ grafana_agent_logs_url }}"
            tenant_id: "{{ grafana_agent_tenant }}"
            external_labels: "{{ grafana_agent_external_labels }}"

grafana_agent_combined_config: >-
  {{
    grafana_agent_default_config |
    combine(grafana_agent_config, recursive=True, list_merge="append")
  }}
